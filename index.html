<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tabib AI - Pesan Herbal</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f4f8; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; }
    .section { width: 100%; max-width: 500px; background: white; padding: 20px; margin-top: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    input, textarea { width: 100%; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
    button { margin-top: 15px; padding: 10px 20px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; }
    .primary { background: #3498db; color: white; }
    .success { background: #2ecc71; color: white; }
    .dot { width: 16px; height: 16px; border-radius: 50%; background-color: #ccc; display: inline-block; margin-right: 10px; }
    .dot.active { background-color: #3498db; }
    .spinner { display: inline-block; animation: spin 1.2s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <h1>üß™ Tabib AI - Pesan Herbal</h1>

  <!-- Step 1: Nama -->
  <div id="step1" class="section">
    <h2>1. Masukkan Nama</h2>
    <input type="text" id="namaInput" placeholder="Contoh: Budi" />
    <button class="primary" onclick="lanjutKeKeluhan()">Lanjut</button>
  </div>

  <!-- Step 2: Keluhan -->
  <div id="step2" class="section hidden">
    <h2>2. Tulis Keluhan</h2>
    <textarea id="keluhanInput" placeholder="Keluhan Anda..."></textarea>
    <button class="primary" onclick="kirimKeluhan()">Kirim</button>
  </div>

  <!-- Status -->
  <div id="proses" class="section hidden">
    <h2><span class="spinner">‚è≥</span> <span id="statusText">Obat sedang diproses...</span></h2>
    <p><span class="dot" id="dot1"></span> Mengirim ke Tabib AI</p>
    <p><span class="dot" id="dot2"></span> Tabib meresepkan</p>
    <p><span class="dot" id="dot3"></span> Resep jadi</p>
    <p><span class="dot" id="dot4"></span> Resep dikirim ke juru ramu</p>
  </div>

  <!-- Selesai -->
  <div id="buatObat" class="section hidden">
    <h2>‚úÖ Ramuan siap dibuat!</h2>
    <button class="success" onclick="alert('Mesin mulai membuat ramuan...')">üîß Buat Ramuan</button>
  </div>

  <!-- MQTT via CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    let namaPembeli = '';

    function lanjutKeKeluhan() {
      const nama = document.getElementById('namaInput').value.trim();
      if (!nama) return alert('Masukkan nama terlebih dahulu.');
      namaPembeli = nama;
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
    }

    function kirimKeluhan() {
      const keluhan = document.getElementById('keluhanInput').value.trim();
      if (!keluhan) return alert('Tuliskan keluhan terlebih dahulu.');

      // Simulasi proses
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('proses').classList.remove('hidden');

      document.getElementById('dot1').classList.add('active');
      setTimeout(() => document.getElementById('dot2').classList.add('active'), 1000);
      setTimeout(() => document.getElementById('dot3').classList.add('active'), 2000);
      setTimeout(() => document.getElementById('dot4').classList.add('active'), 3000);
    }

    // MQTT Setup
    const mqttOptions = {
      username: 'herbal',
      password: 'Astari1412',
      connectTimeout: 4000,
      reconnectPeriod: 1000,
      clean: true
    };

    const mqttClient = mqtt.connect('wss://aaa73f0ae1d24cc3bf099bad4916f53e.s1.eu.hivemq.cloud/mqtt', mqttOptions);

    mqttClient.on('connect', () => {
      console.log('‚úÖ MQTT Connected!');
      mqttClient.subscribe('tabibai/status', err => {
        if (err) console.error('‚ùå Gagal subscribe:', err.message);
        else console.log('üì° Subscribed ke tabibai/status');
      });
    });

    mqttClient.on('message', (topic, msg) => {
      console.log('üì® MQTT message:', msg.toString());

      if (topic === 'tabibai/status') {
        try {
          const data = JSON.parse(msg.toString());
          if (data?.nama?.toLowerCase() === namaPembeli.toLowerCase() && data.status === 'done') {
            console.log('‚úÖ Trigger diterima, ramuan selesai!');
            document.getElementById('statusText').textContent = 'üß™ Ramuan siap dibuat!';
            document.querySelector('.spinner')?.remove();
            setTimeout(() => {
              document.getElementById('proses').classList.add('hidden');
              document.getElementById('buatObat').classList.remove('hidden');
            }, 1500);
          }
        } catch (e) {
          console.error('‚ùå Format MQTT salah:', e.message);
        }
      }
    });
  </script>
</body>
</html>
